<section
  class="round-wrapper"
  [class.is-my-turn]="viewState === 'playing' || viewState === 'drinking'"
>
  <!-- HUD -->
  <div
    class="player-hud"
    *ngIf="currentLives !== null && viewState !== 'lost' && viewState !== 'finished'"
  >
    <div class="player-lives">{{ currentLives }} <span class="bigger-emoji">ğŸ»</span></div>
  </div>

  <!-- PLAYING -->
  <ng-container *ngIf="viewState === 'playing'">
    <ng-container *ngTemplateOutlet="playing"></ng-container>
  </ng-container>

  <!-- WAITING -->
  <ng-container *ngIf="viewState === 'waiting'">
    <ng-container *ngTemplateOutlet="waiting"></ng-container>
  </ng-container>

  <!-- DRINKING -->
  <ng-container *ngIf="viewState === 'drinking'">
    <ng-container *ngTemplateOutlet="drinking"></ng-container>
  </ng-container>

  <!-- LOST -->
  <ng-container *ngIf="viewState === 'lost'">
    <ng-container *ngTemplateOutlet="lost"></ng-container>
  </ng-container>

  <!-- FINISHED -->
  <ng-container *ngIf="viewState === 'finished'">
    <ng-container *ngTemplateOutlet="finished"></ng-container>
  </ng-container>
</section>

<!-- =========================
      PLAYING
========================= -->
<ng-template #playing>
  <section class="view view-playing">
    <div class="view-scroll">
      <header class="view-header">
        <h2>Din tur</h2>
        <p class="subtitle">Velg et kort Ã¥ spille ğŸ»</p>
      </header>

      <!-- HÃ…NDEN -->
      <div class="card-hand" *ngIf="hand.length">
        <button
          *ngFor="let c of hand; let i = index"
          class="hand-card"
          [class.is-selected]="i === selectedIndex"
          [class.type-attack]="c.type === 'attack'"
          [class.type-defence]="c.type === 'defence'"
          [class.type-curse]="c.type === 'curse'"
          (click)="onSelectCard(i)"
          [style.--i]="i"
          [style.--total]="hand.length"
        >
          <ng-container
            *ngTemplateOutlet="cardFace; context: { $implicit: c, mode: 'hand' }"
          ></ng-container>
        </button>
      </div>

      <!-- DETALJER -->
      <div class="card-details" *ngIf="selectedCard">
        <h3 class="details-title">{{ selectedCard.title }}</h3>
        <p class="card-details-description">{{ selectedCard.description }}</p>

        <p class="card-meta" [ngClass]="'card-type-' + selectedCard.type">
          {{ selectedCard.drinkAmount }} slurk â€¢ Passiv:
          {{ selectedCard.passive.join(', ') }}
        </p>

        <button class="btn primary" *ngIf="!selectingTarget" (click)="onPlaySelectedCard()">
          Spill dette kortet
        </button>

        <!-- TARGET-SELECTION -->
        <div class="target-select" *ngIf="selectingTarget && pendingCardToPlay">
          <h3 class="target-title">Velg hvem som skal fÃ¥ kortet</h3>

          <ul class="target-list">
            <li *ngFor="let p of targetCandidates" class="target-row">
              <button
                type="button"
                class="target-button"
                [class.is-selected]="p.id === selectedTargetId"
                (click)="onSelectTarget(p.id)"
              >
                <span class="target-name">{{ p.name }}</span>
                <span class="target-lives">{{ p.lives }} ğŸ»</span>
              </button>
            </li>
          </ul>

          <div class="target-actions">
            <button class="btn secondary" type="button" (click)="onCancelTargetSelection()">
              Avbryt
            </button>
            <button
              class="btn primary"
              type="button"
              (click)="onConfirmTargetSelection()"
              [disabled]="!selectedTargetId"
            >
              Bekreft mÃ¥l
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</ng-template>

<!-- =========================
      WAITING
========================= -->
<ng-template #waiting>
  <section class="view view-waiting">
    <div class="view-scroll">
      <header class="view-header">
        <h2>Venter pÃ¥ tur</h2>

        <ng-container *ngIf="lastPlayedCard; else noLastCard">
          <ng-container *ngIf="lastPlayedCard.type === 'attack'; else nonAttackInfo">
            <ng-container *ngTemplateOutlet="pendingAttackBlock"></ng-container>
          </ng-container>

          <ng-template #nonAttackInfo>
            <p class="subtitle">
              <strong>{{ lastPlayedBy?.name }}</strong>
              spilte et <strong>{{ getCardTypeUpper(lastPlayedCard) }}</strong
              >-kort ğŸ»
            </p>
          </ng-template>
        </ng-container>

        <ng-template #noLastCard>
          <p class="subtitle" *ngIf="currentTurnPlayer; else noCurrent">
            Det er <strong>{{ currentTurnPlayer.name }}</strong> sin tur ğŸ»
          </p>

          <ng-template #noCurrent>
            <p class="subtitle">Venter pÃ¥ at neste spiller skal velges...</p>
          </ng-template>
        </ng-template>
      </header>

      <hr class="divider" />

      <section class="waiting-list-section">
        <h3>Spillere i spillet</h3>

        <div class="waiting-player-scroll" *ngIf="players.length; else noPlayers">
          <ul class="waiting-player-list">
            <li
              *ngFor="let p of players"
              class="waiting-player-row"
              [class.is-current]="p.id === currentTurnPlayerId"
            >
              <div class="wp-main">
                <span class="wp-name">{{ p.name }}</span>
                <span class="wp-lives">{{ p.lives }} ğŸ»</span>
              </div>

              <div class="wp-meta" *ngIf="playerHasSkip[p.id]">Skipper neste tur â­ï¸</div>
              <div class="wp-meta" *ngIf="!playerHasSkip[p.id] && p.id === currentTurnPlayerId">
                Spiller nÃ¥
              </div>
              <div class="wp-meta" *ngIf="!playerHasSkip[p.id] && p.id !== currentTurnPlayerId">
                Venter pÃ¥ tur
              </div>
            </li>
          </ul>
        </div>

        <ng-template #noPlayers>
          <p>Ingen spillere registrert i denne sessionen ğŸ¤”</p>
        </ng-template>
      </section>
    </div>
  </section>
</ng-template>

<!-- =========================
      DRINKING
========================= -->
<ng-template #drinking>
  <section class="view view-drinking">
    <div class="view-scroll">
      <header class="view-header">
        <h2>Du skal drikke</h2>
      </header>

      <ng-container *ngTemplateOutlet="pendingAttackBlock"></ng-container>

      <button
        class="btn primary"
        (click)="onConfirmDrank()"
        [disabled]="!canConfirmDrank"
        style="margin-top: 1.5rem"
      >
        Jeg har drukket ğŸ»
      </button>

      <p class="confirm-hint" *ngIf="!canConfirmDrank && expectedEffectCount > 0">
        Venter pÃ¥ effekter... ({{ effectRevealCount }}/{{ expectedEffectCount }})
      </p>
    </div>
  </section>
</ng-template>

<!-- =========================
      LOST / FINISHED
========================= -->
<ng-template #lost>
  <section class="card">
    <h2>Du er ute ğŸ˜µ</h2>
    <p>Du kan fortsatt fÃ¸lge med pÃ¥ spillet.</p>
  </section>
</ng-template>

<ng-template #finished>
  <section class="card">
    <h2>Spillet er ferdig ğŸ‰</h2>
    <p>Her kan vi vise hvem som vant og evt. "nytt spill".</p>
  </section>
</ng-template>

<!-- =========================
      CARD TEMPLATE (re-used everywhere)
========================= -->
<ng-template #cardFace let-card let-mode="mode">
  <div class="card-img">
    <img
      class="card-image"
      [src]="getCardImageSrc(card)"
      (error)="onCardImgError($event)"
      loading="lazy"
    />
  </div>

  <div class="card-info">
    <div class="card-title" [ngClass]="getTitleSizeClass(card.title)">{{ card.title }}</div>
    <div class="card-type">{{ getCardTypeUpper(card) }}</div>
  </div>
</ng-template>

<!-- =========================
      PENDING ATTACK TEMPLATE (shared)
========================= -->
<ng-template #pendingAttackBlock>
  <p class="subtitle" *ngIf="lastPlayedBy && pendingAttackCard">
    <strong>{{ lastPlayedBy.name }}</strong>
    sendte dette kortet til
    <strong>{{ pendingAttackTarget?.name || 'en spiller' }}</strong> ğŸ»
  </p>

  <div class="waiting-attack-wrapper" *ngIf="pendingAttackCard">
    <button
      class="hand-card hand-card--single"
      [class.type-attack]="pendingAttackCard.type === 'attack'"
      [class.type-defence]="pendingAttackCard.type === 'defence'"
      [class.type-curse]="pendingAttackCard.type === 'curse'"
      disabled
    >
      <ng-container
        *ngTemplateOutlet="cardFace; context: { $implicit: pendingAttackCard, mode: 'single' }"
      ></ng-container>
    </button>
  </div>

  <p class="attack-description" *ngIf="pendingAttackCard">
    {{ pendingAttackCard.description }}
  </p>

  <div class="effect-sequence" *ngIf="allEffectCards.length > 0">
    <h3>Effekter i spill</h3>

    <!-- âœ… Progress dots -->
    <div class="effect-dots" *ngIf="expectedEffectCount > 0">
      <span
        *ngFor="let _ of effectDotArray; let i = index"
        class="dot"
        [class.filled]="i < effectRevealCount"
      ></span>
    </div>

    <!-- âœ… Stacked â€œpileâ€ instead of side-by-side -->
    <div class="effect-stack">
      <ng-container *ngFor="let c of allEffectCards; let i = index">
        <button
          class="hand-card hand-card--single effect-card-stacked"
          [class.type-attack]="c.type === 'attack'"
          [class.type-defence]="c.type === 'defence'"
          [class.type-curse]="c.type === 'curse'"
          [class.is-revealed]="i < effectRevealCount"
          [style.--rot]="getEffectRotation(i)"
          [style.--from]="getEffectFrom(i)"
          [style.zIndex]="100 + i"
          [style.--lift]="i"
          disabled
        >
          <ng-container *ngTemplateOutlet="cardFace; context: { $implicit: c, mode: 'single' }">
          </ng-container>
        </button>
      </ng-container>
    </div>
  </div>

  <p class="total-drinks" *ngIf="pendingAttackCard && pendingAttackTarget">
    {{ pendingAttackTarget.name }} mÃ¥ drikke
    {{ displayPendingTotal }}
    slurk{{ displayPendingTotal === 1 ? '' : 'er' }}.
  </p>

  <p class="calc-details" *ngIf="pendingAttackCard">
    {{ getAttackTotalBreakdownAnimated() }}
  </p>
</ng-template>
