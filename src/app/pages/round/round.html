<!-- round.html -->
<section
  class="round-wrapper"
  [class.is-my-turn]="viewState === 'playing' || viewState === 'drinking'"
>
  <!-- HUD -->
  @if (currentLives !== null && viewState !== 'lost' && viewState !== 'finished') {
  <div class="player-hud">
    <div class="player-lives">{{ currentLives }} <span class="bigger-emoji">ğŸ»</span></div>
  </div>
  }

  <!-- âœ… RANDOM OVERLAY (tivolihjul) -->
  @if (randomOverlayVisible) {
  <div
    class="random-overlay"
    [class.is-visible]="randomOverlayVisible && !randomOverlayHiding"
    [class.is-hiding]="randomOverlayHiding"
  >
    <div class="random-overlay-inner">
      <!-- card + countdown (alltid i starten) -->
      @if (pendingAttackCard) {
      <div class="random-card-block">
        <div class="random-card-title">ğŸ¡ Random-kort</div>

        <div class="random-card-wrapper">
          <button
            class="hand-card hand-card--single"
            [class.type-attack]="pendingAttackCard.type === 'attack'"
            [class.type-defence]="pendingAttackCard.type === 'defence'"
            [class.type-curse]="pendingAttackCard.type === 'curse'"
            disabled
          >
            <ng-container
              *ngTemplateOutlet="
                cardFace;
                context: { $implicit: pendingAttackCard, mode: 'single' }
              "
            ></ng-container>
          </button>
        </div>

        @if (randomPhase === 'countdown') {
        <div class="random-countdown">
          Starter om <strong>{{ randomCountdown }}</strong
          >â€¦
        </div>
        }
      </div>
      }

      <!-- wheel -->
      <div class="wheel-shell" [class.is-shown]="randomPhase !== 'idle'">
        @if (randomPhase === 'spinning') {
        <div class="wheel-title">Spinningâ€¦ ğŸ </div>
        } @if (randomPhase === 'done' && randomWheelWinner) {
        <div class="wheel-title">
          Landet pÃ¥ <strong>{{ randomWheelWinner.name }}</strong> ğŸ»
        </div>
        }

        <div class="wheel-window">
          <div class="wheel-marker"></div>

          <div class="wheel-reel">
            <div
              class="wheel-strip-vertical"
              [class.is-spinning]="randomPhase === 'spinning'"
              [style.transform]="wheelTransform"
              [style.transition]="wheelTransition"
            >
              @for (p of wheelReelItems; track $index) {
              <div class="wheel-item-vertical">
                {{ p.name }}
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- PLAYING -->
  @if (viewState === 'playing') {
  <ng-container *ngTemplateOutlet="playing"></ng-container>
  }

  <!-- WAITING -->
  @if (viewState === 'waiting') {
  <ng-container *ngTemplateOutlet="waiting"></ng-container>
  }

  <!-- DRINKING -->
  @if (viewState === 'drinking') {
  <ng-container *ngTemplateOutlet="drinking"></ng-container>
  }

  <!-- LOST -->
  @if (viewState === 'lost') {
  <ng-container *ngTemplateOutlet="lost"></ng-container>
  }

  <!-- FINISHED -->
  @if (viewState === 'finished') {
  <ng-container *ngTemplateOutlet="finished"></ng-container>
  }
</section>

<!-- =========================
      PLAYING
========================= -->
<ng-template #playing>
  <section class="view view-playing">
    <div class="view-scroll">
      <header class="view-header">
        <h2>Din tur</h2>
        <p class="subtitle">Velg et kort Ã¥ spille ğŸ»</p>
      </header>

      <!-- HÃ…NDEN -->
      @if (hand.length) {
      <div class="card-hand">
        @for (c of hand; track c.id; let i = $index) {
        <button
          class="hand-card"
          [class.is-selected]="i === selectedIndex"
          [class.type-attack]="c.type === 'attack'"
          [class.type-defence]="c.type === 'defence'"
          [class.type-curse]="c.type === 'curse'"
          (click)="onSelectCard(i)"
          [style.--i]="i"
          [style.--total]="hand.length"
        >
          <ng-container
            *ngTemplateOutlet="cardFace; context: { $implicit: c, mode: 'hand' }"
          ></ng-container>
        </button>
        }
      </div>
      }

      <!-- DETALJER -->
      @if (selectedCard) {
      <div class="card-details">
        <h3 class="details-title">{{ selectedCard.title }}</h3>
        <p class="card-details-description">{{ selectedCard.description }}</p>

        <p class="card-meta" [ngClass]="'card-type-' + selectedCard.type">
          {{ selectedCard.drinkAmount }} slurk â€¢ Passiv:
          {{ selectedCard.passive.join(', ') }}
        </p>

        @if (!selectingTarget) {
        <button
          class="btn primary"
          (click)="onPlaySelectedCard()"
          [disabled]="isBtnLocked('playSelected')"
        >
          Spill dette kortet
        </button>
        }

        <!-- âœ… TARGET-SELECTION (skal IKKE vises nÃ¥r selected card er random) -->
        @if (selectingTarget && pendingCardToPlay && !isRandomSelected) {
        <div class="target-select">
          <h3 class="target-title">Velg hvem som skal fÃ¥ kortet</h3>

          <ul class="target-list">
            @for (p of targetCandidates; track p.id) {
            <li class="target-row">
              <button
                type="button"
                class="target-button"
                [class.is-selected]="p.id === selectedTargetId"
                (click)="onSelectTarget(p.id)"
              >
                <span class="target-name">{{ p.name }}</span>
                <span class="target-lives">{{ p.lives }} ğŸ»</span>
              </button>
            </li>
            }
          </ul>

          <div class="target-actions">
            <button
              class="btn secondary"
              type="button"
              (click)="onCancelTargetSelection()"
              [disabled]="isBtnLocked('cancelTarget')"
            >
              Avbryt
            </button>
            <button
              class="btn primary"
              type="button"
              (click)="onConfirmTargetSelection()"
              [disabled]="isBtnLocked('confirmTarget') || !selectedTargetId"
            >
              Bekreft mÃ¥l
            </button>
          </div>
        </div>
        }

        <!-- âœ… hint nÃ¥r random er valgt -->
        @if (isRandomSelected) {
        <p class="subtitle" style="margin-top: 0.75rem; text-align: center">
          Random-kort velger mÃ¥l selv ğŸ¡
        </p>
        }
      </div>
      }
    </div>
  </section>
</ng-template>

<!-- =========================
      WAITING
========================= -->
<ng-template #waiting>
  <section class="view view-waiting">
    <div class="view-scroll">
      <ng-container *ngTemplateOutlet="waitingContent; context: { mode: 'waiting' }"></ng-container>
    </div>
  </section>
</ng-template>

<!-- Shared waiting content (brukes av bÃ¥de waiting og lost) -->
<ng-template #waitingContent let-mode="mode">
  <header class="view-header">
    @if (mode === 'lost') {
    <div class="lost-banner">
      <span class="lost-badge">Du er ute ğŸ˜µ</span>
      <span class="lost-sub">Men du kan fortsatt fÃ¸lge med pÃ¥ alt som skjer</span>
    </div>
    } @if (mode !== 'lost') {
    <h2>Venter pÃ¥ tur</h2>
    } @if (mode === 'lost') {
    <h2>FÃ¸lger med</h2>
    } @if (lastPlayedCard) { @if (lastPlayedCard.type === 'attack') {
    <ng-container *ngTemplateOutlet="pendingAttackBlock"></ng-container>
    } @else {
    <p class="subtitle">
      <strong>{{ lastPlayedBy?.name }}</strong>
      spilte et <strong>{{ getCardTypeUpper(lastPlayedCard) }}</strong
      >-kort ğŸ»
    </p>
    } } @else { @if (currentTurnPlayer) {
    <p class="subtitle">
      Det er <strong>{{ currentTurnPlayer.name }}</strong> sin tur ğŸ»
    </p>
    } @else {
    <p class="subtitle">Venter pÃ¥ at neste spiller skal velges...</p>
    } }
  </header>

  <hr class="divider" />

  <section class="waiting-list-section">
    <h3>Spillere i spillet</h3>

    @if (players.length) {
    <div class="waiting-player-scroll">
      <ul class="waiting-player-list">
        @for (p of players; track p.id) {
        <li
          class="waiting-player-row"
          [class.is-current]="p.id === currentTurnPlayerId"
          [class.is-out]="p.lives <= 0"
        >
          <div class="wp-main">
            <span class="wp-name">{{ p.name }}</span>
            <span class="wp-lives">{{ p.lives }} ğŸ»</span>
          </div>

          @if (playerHasSkip[p.id]) {
          <div class="wp-meta">Skipper neste tur â­ï¸</div>
          } @if (!playerHasSkip[p.id] && p.id === currentTurnPlayerId) {
          <div class="wp-meta">Spiller nÃ¥</div>
          } @if (!playerHasSkip[p.id] && p.id !== currentTurnPlayerId) {
          <div class="wp-meta">Venter pÃ¥ tur</div>
          }
        </li>
        }
      </ul>
    </div>
    } @else {
    <p>Ingen spillere registrert i denne sessionen ğŸ¤”</p>
    }
  </section>
</ng-template>

<!-- =========================
      DRINKING
========================= -->
<ng-template #drinking>
  <section class="view view-drinking">
    <div class="view-scroll">
      <header class="view-header">
        <h2>Du skal drikke</h2>
      </header>

      <ng-container *ngTemplateOutlet="pendingAttackBlock"></ng-container>

      <!-- âœ… REFLECT BUTTON (skjules helt til reflect-kortet er revealed) -->
      @if (reflectUiReady) {
      <button
        class="btn danger"
        (click)="onConfirmReflect()"
        [disabled]="isBtnLocked('confirmReflect') || !canConfirmReflect"
        style="margin-top: 1.5rem"
      >
        ğŸ” Reflect kort tilbake
      </button>
      }

      <!-- âœ… IKKE vis â€œJeg har drukketâ€ nÃ¥r reflect er klar og ikke allerede reflectet -->
      @if (!reflectUiReady) {
      <button
        class="btn primary"
        (click)="onConfirmDrank()"
        [disabled]="isBtnLocked('confirmDrank') || !canConfirmDrank"
        style="margin-top: 1.5rem"
      >
        Jeg har drukket ğŸ»
      </button>
      } @if (!canConfirmDrank && expectedEffectCount > 0) {
      <p class="confirm-hint">
        Venter pÃ¥ effekter... ({{ effectRevealCount }}/{{ expectedEffectCount }})
      </p>
      } @if (reflectUiReady && !roundState?.pendingAttackIsReflect) {
      <p class="confirm-hint">Trykk reflect for Ã¥ sende kortet tilbake ğŸ”</p>
      }
    </div>
  </section>
</ng-template>

<!-- =========================
      LOST / FINISHED
========================= -->
<ng-template #lost>
  <section class="view view-lost">
    <div class="view-scroll">
      <ng-container *ngTemplateOutlet="waitingContent; context: { mode: 'lost' }"></ng-container>
    </div>
  </section>
</ng-template>

<ng-template #finished>
  <section class="view view-finished">
    <div class="view-scroll">
      <header class="view-header">
        <h2>Spillet er ferdig ğŸ‰</h2>
        <p class="subtitle">Podium (1.â€“3. plass)</p>
      </header>

      @if (podiumPlayers.length) {
      <div class="podium">
        @if (podiumPlayers[1]) {
        <div class="podium-slot second">
          <div class="podium-rank">2</div>
          <div class="podium-name">{{ podiumPlayers[1].name }}</div>
        </div>
        } @if (podiumPlayers[0]) {
        <div class="podium-slot first">
          <div class="podium-crown">ğŸ‘‘</div>
          <div class="podium-rank">1</div>
          <div class="podium-name">{{ podiumPlayers[0].name }}</div>
        </div>
        } @if (podiumPlayers[2]) {
        <div class="podium-slot third">
          <div class="podium-rank">3</div>
          <div class="podium-name">{{ podiumPlayers[2].name }}</div>
        </div>
        }
      </div>
      }

      <hr class="divider" />

      <section class="standings">
        <h3>Full liste</h3>
        <ul class="standings-list">
          @for (p of standingsPlayers; track p.id; let i = $index) {
          <li class="standings-row">
            <span class="standings-rank">#{{ i + 1 }}</span>
            <span class="standings-name">{{ p.name }}</span>
          </li>
          }
        </ul>
      </section>

      <button class="btn secondary" type="button" (click)="goHome()">Tilbake til start</button>
    </div>
  </section>
</ng-template>

<!-- =========================
      CARD TEMPLATE (re-used everywhere)
========================= -->
<ng-template #cardFace let-card let-mode="mode">
  <div class="card-img">
    <img
      class="card-image"
      [src]="getCardImageSrc(card)"
      (error)="onCardImgError($event)"
      loading="lazy"
    />
  </div>

  <div class="card-info">
    <div class="card-title" [ngClass]="getTitleSizeClass(card.title)">{{ card.title }}</div>
    <div class="card-type">{{ getCardTypeUpper(card) }}</div>
  </div>
</ng-template>

<!-- =========================
      PENDING ATTACK TEMPLATE (shared)
========================= -->
<ng-template #pendingAttackBlock>
  <!-- âœ… Reflect messaging -->
  @if (roundState?.pendingAttackIsReflect) { @if (pendingAttackCard && pendingAttackTarget) {
  <p class="subtitle">
    <strong>{{ reflectorPlayer?.name || 'Noen' }}</strong>
    reflectet kortet tilbake til
    <strong>{{ pendingAttackTarget.name }}</strong> ğŸ” @if (lastPlayedBy) {
    <span>
      (opprinnelig angrep fra <strong>{{ lastPlayedBy.name }}</strong
      >)
    </span>
    }
  </p>
  } } @else {
  <p class="subtitle" *ngIf="lastPlayedBy && pendingAttackCard">
    <strong>{{ lastPlayedBy.name }}</strong>
    sendte dette kortet til
    <strong>{{ pendingAttackTarget?.name || 'en spiller' }}</strong> ğŸ»
  </p>
  } @if (pendingAttackCard) {
  <div class="waiting-attack-wrapper">
    <button
      class="hand-card hand-card--single"
      [class.type-attack]="pendingAttackCard.type === 'attack'"
      [class.type-defence]="pendingAttackCard.type === 'defence'"
      [class.type-curse]="pendingAttackCard.type === 'curse'"
      disabled
    >
      <ng-container
        *ngTemplateOutlet="cardFace; context: { $implicit: pendingAttackCard, mode: 'single' }"
      ></ng-container>
    </button>
  </div>

  <p class="attack-description">
    {{ pendingAttackCard.description }}
  </p>
  } @if (allEffectCards.length > 0) {
  <div class="effect-sequence">
    <h3>Effekter i spill</h3>

    @if (expectedEffectCount > 0) {
    <div class="effect-dots">
      @for (_ of effectDotArray; track $index; let i = $index) {
      <span class="dot" [class.filled]="i < effectRevealCount"></span>
      }
    </div>
    }

    <div class="effect-stack">
      @for (c of allEffectCards; track c.id; let i = $index) {
      <button
        class="hand-card hand-card--single effect-card-stacked"
        [class.type-attack]="c.type === 'attack'"
        [class.type-defence]="c.type === 'defence'"
        [class.type-curse]="c.type === 'curse'"
        [class.is-revealed]="i < effectRevealCount"
        [style.--rot]="getEffectRotation(i)"
        [style.--from]="getEffectFrom(i)"
        [style.zIndex]="100 + i"
        [style.--lift]="i"
        disabled
      >
        <ng-container *ngTemplateOutlet="cardFace; context: { $implicit: c, mode: 'single' }">
        </ng-container>
      </button>
      }
    </div>
  </div>
  }

  <!-- âœ… Total line: reflect-aware -->
  @if (pendingAttackCard) {
  <p class="total-drinks">
    @if (roundState?.pendingAttackIsReflect) {
    {{ pendingAttackTarget?.name }} mÃ¥ drikke
    {{ displayPendingTotal }}
    slurk{{ displayPendingTotal === 1 ? '' : 'er' }}. } @else {
    <!-- âœ… skjul reflect hint til reflect-kortet er revealed -->
    @if (reflectUiReady) { ğŸ” Reflect klar! Send {{ displayPendingTotal }} slurk tilbake til
    <strong>{{ lastPlayedBy?.name }}</strong
    >. } @else { {{ pendingAttackTarget?.name }} mÃ¥ drikke
    {{ displayPendingTotal }}
    slurk{{ displayPendingTotal === 1 ? '' : 'er' }}. } }
  </p>

  <p class="calc-details">
    {{ getAttackTotalBreakdownAnimated() }}
  </p>
  }
</ng-template>
