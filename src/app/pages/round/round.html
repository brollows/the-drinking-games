<section class="round-wrapper">
  <div
    class="player-hud"
    *ngIf="currentLives !== null && viewState !== 'lost' && viewState !== 'finished'"
  >
    <div class="player-lives">{{ currentLives }} <span class="bigger-emoji">ğŸ»</span></div>
  </div>

  <!-- PLAYING -->
  <ng-container *ngIf="viewState === 'playing'">
    <ng-container *ngTemplateOutlet="playing"></ng-container>
  </ng-container>

  <!-- WAITING -->
  <ng-container *ngIf="viewState === 'waiting'">
    <ng-container *ngTemplateOutlet="waiting"></ng-container>
  </ng-container>

  <!-- DRINKING -->
  <ng-container *ngIf="viewState === 'drinking'">
    <ng-container *ngTemplateOutlet="drinking"></ng-container>
  </ng-container>

  <!-- LOST -->
  <ng-container *ngIf="viewState === 'lost'">
    <ng-container *ngTemplateOutlet="lost"></ng-container>
  </ng-container>

  <!-- FINISHED -->
  <ng-container *ngIf="viewState === 'finished'">
    <ng-container *ngTemplateOutlet="finished"></ng-container>
  </ng-container>
</section>

<!--Alle statene er under-->

<ng-template #playing>
  <section class="playing-state">
    <h2>Din tur</h2>
    <p class="subtitle">Velg et kort Ã¥ spille ğŸ»</p>

    <!-- HÃ…NDEN -->
    <div class="card-hand" *ngIf="hand.length">
      <button
        *ngFor="let c of hand; let i = index"
        class="hand-card"
        [class.is-selected]="i === selectedIndex"
        [class.type-attack]="c.type === 'attack'"
        [class.type-defence]="c.type === 'defence'"
        [class.type-curse]="c.type === 'curse'"
        (click)="onSelectCard(i)"
        [style.--i]="i"
        [style.--total]="hand.length"
      >
        <div class="hand-card-title">{{ c.title }}</div>
        <div class="hand-card-body">
          <div class="hand-card-drink">{{ getCardTypeUpper(c) }}</div>
        </div>
      </button>
    </div>

    <!-- DETALJER FOR VALGT KORT -->
    <div class="card-details" *ngIf="selectedCard">
      <h3>{{ selectedCard.title }}</h3>
      <p>{{ selectedCard.description }}</p>

      <p class="card-meta">
        {{ selectedCard.drinkAmount }} slurk â€¢ Passiv:
        {{ selectedCard.passive.join(', ') }}
      </p>

      <!-- Hvis vi IKKE er i target-modus: vanlig "Spill" knapp -->
      <button class="btn primary" *ngIf="!selectingTarget" (click)="onPlaySelectedCard()">
        Spill dette kortet
      </button>

      <!-- TARGET-SELECTION UI -->
      <div class="target-select" *ngIf="selectingTarget && pendingCardToPlay">
        <h3 style="margin-top: 1.5rem">Velg hvem som skal fÃ¥ kortet</h3>

        <ul class="target-list">
          <li *ngFor="let p of targetCandidates" class="target-row">
            <button
              type="button"
              class="target-button"
              [class.is-selected]="p.id === selectedTargetId"
              (click)="onSelectTarget(p.id)"
            >
              <span class="target-name">{{ p.name }}</span>
              <span class="target-lives">{{ p.lives }} ğŸ»</span>
            </button>
          </li>
        </ul>

        <div class="target-actions">
          <button class="btn secondary" type="button" (click)="onCancelTargetSelection()">
            Avbryt
          </button>
          <button
            class="btn primary"
            type="button"
            (click)="onConfirmTargetSelection()"
            [disabled]="!selectedTargetId"
          >
            Bekreft mÃ¥l
          </button>
        </div>
      </div>
    </div>
  </section>
</ng-template>

<!-- waiting-state.html -->
<ng-template #waiting>
  <section class="waiting-state">
    <h2>Venter pÃ¥ tur</h2>

    <!-- sist spilte kort hvis det finnes -->
    <ng-container *ngIf="lastPlayedCard; else noLastCard">
      <ng-container *ngIf="lastPlayedCard.type === 'attack'; else nonAttackInfo">
        <p class="subtitle">
          <strong>{{ lastPlayedBy?.name }}</strong>
          sendte et angrep til
          <strong>{{ lastPlayedTarget?.name || 'en spiller' }}</strong>
          ğŸ»
        </p>

        <div class="waiting-attack-wrapper">
          <button
            class="hand-card waiting-hand-card"
            [class.type-attack]="lastPlayedCard.type === 'attack'"
            disabled
          >
            <div class="hand-card-title">{{ lastPlayedCard.title }}</div>
            <div class="hand-card-body">
              <div class="hand-card-drink">
                {{ getCardTypeUpper(lastPlayedCard) }}
              </div>
            </div>
          </button>
        </div>
      </ng-container>

      <ng-template #nonAttackInfo>
        <p class="subtitle">
          <strong>{{ lastPlayedBy?.name }}</strong>
          spilte et
          <strong>{{ lastPlayedCard.type.toUpperCase() }}</strong
          >-kort ğŸ»
        </p>
      </ng-template>
    </ng-container>

    <ng-template #noLastCard>
      <p class="subtitle" *ngIf="currentTurnPlayer; else noCurrent">
        Det er <strong>{{ currentTurnPlayer.name }}</strong> sin tur ğŸ»
      </p>

      <ng-template #noCurrent>
        <p class="subtitle">Venter pÃ¥ at neste spiller skal velges...</p>
      </ng-template>
    </ng-template>

    <hr class="divider" />

    <h3>Spillere i spillet</h3>

    <ul class="waiting-player-list" *ngIf="players.length; else noPlayers">
      <li
        *ngFor="let p of players"
        class="waiting-player-row"
        [class.is-current]="p.id === currentTurnPlayerId"
      >
        <div class="wp-main">
          <span class="wp-name">{{ p.name }}</span>
          <span class="wp-lives">{{ p.lives }} ğŸ»</span>
        </div>

        <div class="wp-meta" *ngIf="p.id === currentTurnPlayerId">Spiller nÃ¥</div>
        <div class="wp-meta" *ngIf="p.id !== currentTurnPlayerId">Venter pÃ¥ tur</div>
      </li>
    </ul>

    <ng-template #noPlayers>
      <p>Ingen spillere registrert i denne sessionen ğŸ¤”</p>
    </ng-template>
  </section>
</ng-template>

<ng-template #drinking>
  <section class="waiting-state">
    <h2>Du er under angrep! ğŸ˜ˆ</h2>

    <p class="subtitle">
      <strong>{{ lastPlayedBy?.name }}</strong>
      sendte dette kortet til deg:
    </p>

    <div class="waiting-attack-wrapper" *ngIf="lastPlayedCard">
      <button
        class="hand-card waiting-hand-card"
        [class.type-attack]="lastPlayedCard.type === 'attack'"
        disabled
      >
        <div class="hand-card-title">{{ lastPlayedCard.title }}</div>
        <div class="hand-card-body">
          <div class="hand-card-drink">
            {{ getCardTypeUpper(lastPlayedCard) }}
          </div>
        </div>
      </button>
    </div>

    <div class="card-details waiting-card-details" *ngIf="lastPlayedCard">
      <p>{{ lastPlayedCard.description }}</p>
      <p class="card-meta">
        {{ lastPlayedCard.drinkAmount }} slurk
        <!-- TODO: senere kan vi vise "inkl. curses/defence" eksplisitt -->
      </p>
    </div>

    <button class="btn primary" (click)="onConfirmDrank()" style="margin-top: 1.5rem">
      Jeg har drukket ğŸ»
    </button>
  </section>
</ng-template>

<!-- lost-state.html -->
<ng-template #lost>
  <section class="card">
    <h2>Du er ute ğŸ˜µ</h2>
    <p>Du kan fortsatt fÃ¸lge med pÃ¥ spillet.</p>
  </section>
</ng-template>

<!-- finished-state.html -->
<ng-template #finished>
  <section class="card">
    <h2>Spillet er ferdig ğŸ‰</h2>
    <p>Her kan vi vise hvem som vant og evt. "nytt spill".</p>
  </section>
</ng-template>
